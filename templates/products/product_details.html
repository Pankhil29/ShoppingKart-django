{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
    .product-page {
        /* margin: 60px 0; */
        border: 1px solid var(--primary-border);
        background: var(--white);
        overflow-x: hidden;
        /* border-radius: 13px; */
    }

    .product-image-box {
        background: #fafafa;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 450px;
        /* Sabhi images ke liye fixed height */
        width: 100%;
    }

    .product-image-box img {
        width: 100%;
        max-height: 480px;
        object-fit: contain;
    }

    .product-info {
        padding: 10px 20px;
        display: flex;
        flex-direction: column;
    }

    .product-info h1 {
        font-size: 30px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .rating {
        margin: 6px 0 8px;
        font-size: 16px;
        color: #f5a623;
    }

    .rating span {
        color: var(--text-muted);
        font-weight: 500;
    }

    .price {
        font-size: 26px;
        font-weight: 700;
        color: var(--accent);

    }

    .desc {
        font-size: 15px;
        color: var(--text-muted);
        line-height: 1.7;
        margin-bottom: 15px;
    }

    .select-box label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .select-box select {
        border-radius: 6px;
        padding: 6px 8px;
        /* padding-right: 10px; */
        border: 1px solid var(--primary-border);
    }

    .select-box select:focus {
        border-color: var(--primary);
        box-shadow: none;
    }

    .add-cart-btn {
        background: var(--primary);
        color: #fff !important;
        border-radius: 8px;
        padding: 14px 28px;
        font-weight: 600;
        font-size: 15px;
        border: none;
        transition: 0.2s ease;
        text-decoration: none;
    }

    .add-cart-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        text-decoration: none;
    }

    @media (max-width: 720px) {

        .product-image-box {
            height: 300px;
            /* Mobile pe thodi kam height */
        }

        .product-info h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .price {
            font-size: 26px;

        }

        .border-end-sm-0 {
            border-right: 0 !important;
        }

        .product-info {
            margin: 20px 0 0 20px;

        }
    }

    /* review */
    .review-textarea {
        height: 90px;
        resize: none;
    }

    .btn-purple {
        background-color: #6f42c1;
        color: #fff;
        border-radius: 6px;
    }

    .btn-purple:hover {
        background-color: #59339d;
        color: #fff;
    }

    .review-section h4 {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .review-list::-webkit-scrollbar {
        width: 6px;
    }

    .review-list::-webkit-scrollbar-thumb {
        background-color: #ddd;
        border-radius: 10px;
    }

    .rating-display {
        font-size: 1.1rem;
    }

    .card-text {
        color: #555;
        font-style: italic;
    }

    .rating-summary-box {
        display: flex;
        align-items: center;
        gap: 40px;
        padding-bottom: 30px;
        border-bottom: 1px solid #eee;
    }

    .avg-rating-col {
        text-align: center;
        border-right: 1px solid #eee;
        padding-right: 40px;
    }

    .avg-rating-number {
        font-size: 3rem;
        font-weight: 700;
        color: #038d63;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .progress-bars-col {
        flex-grow: 1;
    }

    .rating-bar-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .progress {
        height: 6px !important;
        flex-grow: 1;
        background-color: #f0f0f0;
    }

    .progress-bar {
        border-radius: 10px;
    }

    /* Review List Styling */
    .user-badge {
        background: #038d63;
        color: white;
        padding: 2px 8px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .review-user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
    }

    .review-user-avatar {
        width: 32px;
        height: 32px;
        background: #eef2ff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #7c3aed;
    }

    /* CSS for proper layout */
    .fw-600 {
        font-weight: 600;
    }

    .border-sm-end {
        border-right: 1px solid #eee;
    }

    .rating-summary-box {
        border: 1px solid #f0f0f0;
    }

    .review-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .add-cart-btn {
        background: var(--primary);
        color: #fff !important;
        border-radius: 8px;
        padding: 12px;
        font-weight: 600;
        width: 100%;
        border: none;
        transition: 0.3s;
    }

    /* Make Form Sticky on desktop */


    @media (max-width: 576px) {
        .border-sm-end {
            border-right: none !important;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .add-cart-btn {
            /* background: var(--primary); */
            /* color: #fff !important; */
            border-radius: 4px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 13px;
            /* border: none; */
            /* transition: 0.2s ease; */
        }

        .avg-rating-number {
            font-size: 2.5rem;
        }
    }

    /* Input styling */
    .review-form textarea {
        width: 100%;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #ddd;
        min-height: 120px;
    }

    .review-form textarea:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.1);
    }

    .review-form select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
</style>

</style>


<div class="container product-page mx-auto my-4 p-3 p-md-5">
    <div class="row align-items-start">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="product-image-box shadow-sm">
                <img src="{{ product.image.url }}" alt="{{ product.product_name }}">
            </div>
        </div>

        <div class="col-md-6">
            <div class="product-info">
                <h1>{{ product.product_name }}</h1>

                <div class="rating mb-2">
                    <span class="text-warning">
                        {% for i in "12345" %}
                        {% if forloop.counter <= avg_rating %} ★ {% else %} ☆ {% endif %} {% endfor %} </span>
                            <small class="text-muted">({{ reviews.count }} reviews)</small>
                </div>

                <div class="price mb-2" id="productPrice">₹ {{ product.min_price }}</div>
                <p id="stockStatus" class="small mb-3"></p>

                <p class="desc text-secondary">{{ product.description }}</p>

                <form method="POST" action="{% url 'add_to_cart' %}" class="mt-auto">
                    {% csrf_token %}
                    <input type="hidden" name="variant_id" id="selectedVariantId"
                        value="{% if not has_size and not has_color %}{{ variants.0.id }}{% endif %}">

                    {% if has_size %}
                    <div class="mb-3">
                        <label class="form-label fw-bold small">Select Size</label>
                        <select class="form-select" id="sizeSelect" required>
                            <option value="">Choose Size</option>
                            {% for v in variants %}
                            <option value="{{ v.id }}" data-price="{{ v.price }}" data-stock="{{ v.stock }}">
                                {{ v.size }} {% if v.color %}({{ v.color }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% elif has_color %}
                    <div class="mb-3">
                        <label class="form-label fw-bold small">Select Color</label>
                        <select class="form-select" id="colorSelect" required>
                            <option value="">Choose Color</option>
                            {% for v in variants %}
                            <option value="{{ v.id }}" data-price="{{ v.price }}" data-stock="{{ v.stock }}">
                                {{ v.color }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div style="width: 120px;">
                            <label class="small fw-bold">Quantity:</label>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary btn-sm" type="button" id="btnMinus">-</button>
                                <input type="number" name="quantity" id="qtyInput"
                                    class="form-control form-control-sm text-center" value="1" readonly>
                                <button class="btn btn-outline-secondary btn-sm" type="button" id="btnPlus">+</button>
                            </div>
                        </div>

                        <button type="button" class="wishlist-btn border-0 bg-transparent mt-4"
                            data-id="{{ product.id }}">
                            <i class="{% if user_wishlist %}fas{% else %}far{% endif %} fa-heart text-danger fs-4"></i>
                        </button>
                    </div>

                    <button type="submit" id="atcBtn" class="add-cart-btn">Add to Cart</button>
                </form>
            </div>
        </div>
    </div>
    <hr class="my-5">

    <div class="container mt-5 mb-5">
        <h4 class="mb-4 text-center fw-bold">Product Ratings & Reviews</h4>

        <div class="row g-4">
            <div class="col-lg-5 order-2 order-lg-1">
                <div class="card border-0 shadow-sm p-4 ">
                    <h5 class="mb-3 fw-bold">Share Your Feedback</h5>
                    {% if request.user.is_authenticated %}
                    <form method="POST" class="review-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label fw-600">How would you rate it?</label>
                            <div class="rating-input-wrapper">
                                {{ form.rating }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-600">Your Experience</label>
                            {{ form.comment }}
                        </div>
                        <button type="submit" class="btn add-cart-btn w-100 py-3 mt-2">Submit Review</button>
                    </form>
                    {% else %}
                    <div class="text-center py-4 bg-light rounded">
                        <p class="mb-2">Want to review this product?</p>
                        <a href="{% url 'login' %}" class="btn btn-purple btn-sm px-4">Login Now</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="col-lg-7 order-1 order-lg-2">
                <div class="rating-summary-box shadow-sm p-4 bg-white rounded mb-4 border-0">
                    <div class="row align-items-center justify-content-center">
                        <div class="col-sm-4 text-center border-sm-end mb-3 mb-sm-0">
                            <div class="avg-rating-number justify-content-center">
                                {{ avg_rating }} <i class="bi bi-star-fill ms-1" style="font-size: 1.4rem;"></i>
                            </div>
                            <div class="text-muted small mt-1">
                                {{ reviews.count }} Ratings & <br> {{ reviews.count }} Reviews
                            </div>
                        </div>

                        <div class="col-sm-8 ps-sm-4">
                            {% for item in rating_breakdown %}
                            <div class="rating-bar-row d-flex align-items-center mb-2 w-100" style="gap: 15px;">

                                <span class="text-muted small"
                                    style="width: 60px; flex-shrink: 0; white-space: nowrap;">
                                    {{ item.label }}
                                </span>

                                <div class="progress"
                                    style="height: 8px; background-color: #f0f0f0; border-radius: 10px; flex-grow: 1; overflow: hidden;">
                                    <div class="progress-bar" role="progressbar"
                                        style="width: {{ item.pct }}%; background-color: {{ item.color }}; border-radius: 10px; height: 100%;"
                                        aria-valuenow="{{ item.pct }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>

                                <span class="text-muted small" style="width: 40px; flex-shrink: 0; text-align: right;">
                                    {{ item.count }}
                                </span>

                            </div>
                            {% endfor %}
                        </div>

                        <div class="reviews-container shadow-sm bg-white rounded p-4 border-0">
                            <h6 class="fw-bold mb-sm-4 m-auto ">Customer Experience ({{ reviews.count }})</h6>
                            <div class="review-list" style="max-height: 800px; overflow-y: auto; padding-right: 10px;">
                                {% for review in reviews %}
                                <div
                                    class="review-item border-bottom py-sm-4 py-2 {% if forloop.last %}border-0{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start mb-sm-2">
                                        <div class="review-user-info">
                                            <div class="review-user-avatar">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0 fw-bold">{{ review.user.username }}</p>
                                                <div class="d-flex align-items-center gap-2 mt-1">
                                                    <span class="user-badge">{{ review.rating }}.0 ★</span>
                                                    <span class="text-muted" style="font-size: 0.75rem;">{{
                                                        review.updated_at|date:"d M Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="mt-3 mb-0 text-secondary" style="font-size: 0.95rem; line-height: 1.6;">{{
                                        review.comment }}</p>
                                </div>
                                {% empty %}
                                <div class="text-center py-sm-5 py-2">
                                    <i class="bi bi-chat-left-text text-muted mb-3"
                                        style="font-size: 2rem; opacity: 0.3;"></i>
                                    <p class="text-muted">No reviews yet. Be the first to share your thoughts!</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const sizeSelect = document.getElementById('sizeSelect');
                const colorSelect = document.getElementById('colorSelect');
                const priceDisplay = document.getElementById('productPrice');
                const variantIdInput = document.getElementById('selectedVariantId');
                const atcBtn = document.getElementById('atcBtn');
                const stockStatus = document.getElementById('stockStatus');
                const qtyInput = document.getElementById('qtyInput');

                // 1. Quantity Controls
                document.getElementById('btnPlus').addEventListener('click', () => {
                    qtyInput.value = parseInt(qtyInput.value) + 1;
                });
                document.getElementById('btnMinus').addEventListener('click', () => {
                    if (qtyInput.value > 1) qtyInput.value = parseInt(qtyInput.value) - 1;
                });

                // 2. Wishlist AJAX (Prevent default form submission)
                $('.wishlist-btn').click(function (e) {
                    e.preventDefault(); // Form submit hone se rokne ke liye
                    var product_id = $(this).data('id');
                    var icon = $(this).find('i');
                    $.ajax({
                        url: "{% url 'wishlist_page' %}",
                        data: { 'id': product_id },
                        success: function (response) {
                            if (response.status == 'added') {
                                icon.removeClass('far').addClass('fas');
                            } else {
                                icon.removeClass('fas').addClass('far');
                            }
                            // Is line se navbar ka count update hoga bina refresh ke
                            $('#wishlist-counter').text(response.wishlist_count);
                        },
                        error: function () {
                            window.location.href = "{% url 'login' %}";
                        }
                    });
                });

                // 3. Variant Update Function
                function updatePrice() {
                    let selectElement = sizeSelect || colorSelect;
                    if (!selectElement) return;

                    const selectedOption = selectElement.options[selectElement.selectedIndex];

                    if (selectedOption && selectedOption.value != "") {
                        const price = selectedOption.getAttribute('data-price');
                        const stock = selectedOption.getAttribute('data-stock');

                        priceDisplay.innerText = "₹ " + price;
                        variantIdInput.value = selectedOption.value; // Hidden field me ID set ho rahi hai

                        if (parseInt(stock) > 0) {
                            stockStatus.innerText = "In Stock (" + stock + " units)";
                            stockStatus.className = "small text-success";
                            atcBtn.innerText = "Add to Cart";
                            atcBtn.disabled = false;
                        } else {
                            stockStatus.innerText = "Out of Stock";
                            stockStatus.className = "small text-danger";
                            atcBtn.innerText = "Out of Stock";
                            atcBtn.disabled = true;
                        }
                    } else {
                        // Agar select nahi kiya toh variant_id khali rakho
                        if (sizeSelect || colorSelect) {
                            variantIdInput.value = "";
                            atcBtn.disabled = true;
                        }
                    }
                }

                // Listeners
                if (sizeSelect) sizeSelect.addEventListener('change', updatePrice);
                if (colorSelect) colorSelect.addEventListener('change', updatePrice);

                // Initial Check (Jab page load ho tabhi check kare variant)
                updatePrice();
            });
        </script>
        {% endblock %}